name: Release QuackOps

on:
  push:
    branches:
      - "master"
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.1.0 or v0.1.0-beta)'
        required: true
        default: 'v1.0.0'
      target_branch:
        description: 'Branch to push Krew manifest updates to'
        required: false
        default: 'master'
      release_notes:
        description: 'Manual release notes (optional)'
        required: false
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Validate version format
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9._-]+)?$ ]]; then
            echo "Error: Version must be in format vX.Y.Z or vX.Y.Z-suffix (e.g., v0.1.0 or v0.1.0-beta)"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag if not exists
        run: |
          if ! git ls-remote --tags origin | grep -q "${{ github.event.inputs.version }}"; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git tag -a ${{ github.event.inputs.version }} -m "Release ${{ github.event.inputs.version }}"
            git push origin ${{ github.event.inputs.version }}
            echo "Created and pushed tag ${{ github.event.inputs.version }}"
          else
            echo "Tag ${{ github.event.inputs.version }} already exists"
          fi

  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests
        run: go test -v ./...

  goreleaser:
    runs-on: ubuntu-latest
    needs: [tests]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name, '-')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-krew-manifest:
    runs-on: ubuntu-latest
    needs: [goreleaser]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref_name, '-')
    permissions:
      contents: write
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master

      - name: Set version from tag
        run: echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Download checksums from release
        run: |
          curl -sSL -O "https://github.com/${{ github.repository }}/releases/download/${VERSION}/checksums.txt"

      - name: Extract platform SHAs
        id: shas
        run: |
          set -euo pipefail
          sha_linux_amd64=$(awk '/linux-amd64/ {print $1}' checksums.txt)
          sha_linux_arm64=$(awk '/linux-arm64/ {print $1}' checksums.txt)
          sha_darwin_amd64=$(awk '/darwin-amd64/ {print $1}' checksums.txt)
          sha_darwin_arm64=$(awk '/darwin-arm64/ {print $1}' checksums.txt)
          echo "sha_linux_amd64=${sha_linux_amd64}" >> $GITHUB_OUTPUT
          echo "sha_linux_arm64=${sha_linux_arm64}" >> $GITHUB_OUTPUT
          echo "sha_darwin_amd64=${sha_darwin_amd64}" >> $GITHUB_OUTPUT
          echo "sha_darwin_arm64=${sha_darwin_arm64}" >> $GITHUB_OUTPUT

      - name: Update plugins/quackops.yaml
        run: |
          mkdir -p plugins
          cat > plugins/quackops.yaml <<EOF
          apiVersion: krew.googlecontainertools.github.com/v1alpha2
          kind: Plugin
          metadata:
            name: quackops
          spec:
            version: ${VERSION}
            homepage: https://github.com/${{ github.repository }}
            shortDescription: AI-powered kubectl plugin for Kubernetes troubleshooting
            description: |
              QuackOps is a kubectl plugin that opens an interactive AI assistant to
              help you diagnose and resolve Kubernetes issues. It keeps session
              context, can suggest commands, and supports local or cloud LLM providers.
            platforms:
            - selector:
                matchLabels:
                  os: linux
                  arch: amd64
              uri: https://github.com/${{ github.repository }}/releases/download/${VERSION}/kubectl-quackops-linux-amd64.tar.gz
              sha256: ${{ steps.shas.outputs.sha_linux_amd64 }}
              bin: kubectl-quackops
            - selector:
                matchLabels:
                  os: linux
                  arch: arm64
              uri: https://github.com/${{ github.repository }}/releases/download/${VERSION}/kubectl-quackops-linux-arm64.tar.gz
              sha256: ${{ steps.shas.outputs.sha_linux_arm64 }}
              bin: kubectl-quackops
            - selector:
                matchLabels:
                  os: darwin
                  arch: amd64
              uri: https://github.com/${{ github.repository }}/releases/download/${VERSION}/kubectl-quackops-darwin-amd64.tar.gz
              sha256: ${{ steps.shas.outputs.sha_darwin_amd64 }}
              bin: kubectl-quackops
            - selector:
                matchLabels:
                  os: darwin
                  arch: arm64
              uri: https://github.com/${{ github.repository }}/releases/download/${VERSION}/kubectl-quackops-darwin-arm64.tar.gz
              sha256: ${{ steps.shas.outputs.sha_darwin_arm64 }}
              bin: kubectl-quackops
          EOF

      - name: Commit and push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add plugins/quackops.yaml
          if git diff --cached --quiet; then
            echo "No manifest changes detected; skipping commit."
            exit 0
          fi
          git commit -m "chore: update krew manifest for ${VERSION}"
          git push origin HEAD:master

  update-krew-manifest-manual:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.target_branch }}

      - name: Set version from input
        run: echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: Download checksums from release
        run: |
          curl -sSL -O "https://github.com/${{ github.repository }}/releases/download/${VERSION}/checksums.txt"

      - name: Extract platform SHAs
        id: shas_manual
        run: |
          set -euo pipefail
          sha_linux_amd64=$(awk '/linux-amd64/ {print $1}' checksums.txt)
          sha_linux_arm64=$(awk '/linux-arm64/ {print $1}' checksums.txt)
          sha_darwin_amd64=$(awk '/darwin-amd64/ {print $1}' checksums.txt)
          sha_darwin_arm64=$(awk '/darwin-arm64/ {print $1}' checksums.txt)
          echo "sha_linux_amd64=${sha_linux_amd64}" >> $GITHUB_OUTPUT
          echo "sha_linux_arm64=${sha_linux_arm64}" >> $GITHUB_OUTPUT
          echo "sha_darwin_amd64=${sha_darwin_amd64}" >> $GITHUB_OUTPUT
          echo "sha_darwin_arm64=${sha_darwin_arm64}" >> $GITHUB_OUTPUT

      - name: Update plugins/quackops.yaml
        run: |
          mkdir -p plugins
          cat > plugins/quackops.yaml <<EOF
          apiVersion: krew.googlecontainertools.github.com/v1alpha2
          kind: Plugin
          metadata:
            name: quackops
          spec:
            version: ${VERSION}
            homepage: https://github.com/${{ github.repository }}
            shortDescription: AI-powered kubectl plugin for Kubernetes troubleshooting
            description: |
              QuackOps is a kubectl plugin that opens an interactive AI assistant to
              help you diagnose and resolve Kubernetes issues. It keeps session
              context, can suggest commands, and supports local or cloud LLM providers.
            platforms:
            - selector:
                matchLabels:
                  os: linux
                  arch: amd64
              uri: https://github.com/${{ github.repository }}/releases/download/${VERSION}/kubectl-quackops-linux-amd64.tar.gz
              sha256: ${{ steps.shas_manual.outputs.sha_linux_amd64 }}
              bin: kubectl-quackops
            - selector:
                matchLabels:
                  os: linux
                  arch: arm64
              uri: https://github.com/${{ github.repository }}/releases/download/${VERSION}/kubectl-quackops-linux-arm64.tar.gz
              sha256: ${{ steps.shas_manual.outputs.sha_linux_arm64 }}
              bin: kubectl-quackops
            - selector:
                matchLabels:
                  os: darwin
                  arch: amd64
              uri: https://github.com/${{ github.repository }}/releases/download/${VERSION}/kubectl-quackops-darwin-amd64.tar.gz
              sha256: ${{ steps.shas_manual.outputs.sha_darwin_amd64 }}
              bin: kubectl-quackops
            - selector:
                matchLabels:
                  os: darwin
                  arch: arm64
              uri: https://github.com/${{ github.repository }}/releases/download/${VERSION}/kubectl-quackops-darwin-arm64.tar.gz
              sha256: ${{ steps.shas_manual.outputs.sha_darwin_arm64 }}
              bin: kubectl-quackops
          EOF

      - name: Commit and push if changed
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add plugins/quackops.yaml
          if git diff --cached --quiet; then
            echo "No manifest changes detected; skipping commit."
            exit 0
          fi
          git commit -m "chore: update krew manifest for ${VERSION}"
          git push origin HEAD:${{ github.event.inputs.target_branch }}

  generate-changelog:
    needs: [goreleaser]
    if: always() && needs.goreleaser.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          else
            echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          fi
          if echo "$VERSION" | grep -q "-"; then
            echo "PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "PRERELEASE=false" >> $GITHUB_ENV
          fi

      - name: Detect release notes from CHANGELOG
        id: detect_notes
        shell: bash
        run: |
          set -euo pipefail
          ver="$VERSION"
          ver_no_v="${ver#v}"
          start_line=$(grep -n -E "^###[[:space:]]*v?${ver_no_v}([[:space:]]|â€”|-|$)" CHANGELOG.md | head -n1 | cut -d: -f1 || true)
          if [ -z "$start_line" ]; then
            echo "has_notes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          # Find the next version heading after start_line
          tail_start=$((start_line + 1))
          next_rel=$(tail -n +$tail_start CHANGELOG.md | grep -n -E "^###[[:space:]]*v[0-9]+\.[0-9]+\.[0-9]+" | head -n1 | cut -d: -f1 || true)
          if [ -n "$next_rel" ]; then
            end_line=$((start_line + next_rel - 2))
            sed -n "${start_line},${end_line}p" CHANGELOG.md > notes.txt
          else
            sed -n "${start_line},\$p" CHANGELOG.md > notes.txt
          fi
          if [ ! -s notes.txt ]; then
            echo "has_notes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "has_notes=true" >> $GITHUB_OUTPUT
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set release notes
        id: release_notes
        run: |
          if [ -n "${{ github.event.inputs.release_notes }}" ]; then
            echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
            echo "${{ github.event.inputs.release_notes }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          elif [ "${{ steps.detect_notes.outputs.has_notes }}" = "true" ]; then
            echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
            echo "${{ steps.detect_notes.outputs.release_notes }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "No release notes found in CHANGELOG.md and none provided via input."
            exit 1
          fi

      - name: Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref_name }}
          body: ${{ env.RELEASE_NOTES }}
          prerelease: ${{ env.PRERELEASE }}
          token: ${{ secrets.GITHUB_TOKEN }}
